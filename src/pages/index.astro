---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const posts = await getCollection('blog', ({ data }) => {
  return !data.draft;
});
const projects = await getCollection('projects');

const featuredPosts = posts
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 3);

const featuredProjects = projects
  .filter(project => project.data.featured)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 3);

const carouselItems = [
  ...featuredPosts.slice(0, 2).map(post => ({
    type: 'post',
    title: post.data.title,
    description: post.data.description || '',
    tags: post.data.tags,
    pubDate: post.data.pubDate,
    gradient: 'from-blue-400 via-cyan-500 to-teal-500',
    bgGradient: 'from-blue-600 via-cyan-600 to-teal-600',
    link: `/posts/${post.id.replace(/\.md$/, '')}`,
    linkText: 'é˜…è¯»æ–‡ç« '
  })),
  ...featuredProjects.slice(0, 2).map(project => ({
    type: 'project',
    title: project.data.title,
    description: project.data.description,
    tags: project.data.tags,
    pubDate: project.data.pubDate,
    gradient: 'from-green-400 via-teal-500 to-cyan-500',
    bgGradient: 'from-green-600 via-teal-600 to-cyan-600',
    link: `/projects/${project.id.replace(/\.md$/, '')}`,
    linkText: 'æŸ¥çœ‹é¡¹ç›®'
  })),
   {
    type: 'hero',
    title: 'A.W.',
    subtitle: 'æŠ€æœ¯åšå®¢',
    description: 'æ¢ç´¢æŠ€æœ¯çš„æ— é™å¯èƒ½ï¼Œåˆ†äº«åˆ›æ–°çš„å®è·µç»éªŒ',
    gradient: 'from-blue-400 via-purple-500 to-pink-500',
    bgGradient: 'from-blue-600 via-purple-600 to-pink-600',
    link: '/posts',
    linkText: 'é˜…è¯»åšå®¢',
    secondaryLink: '/projects',
    secondaryLinkText: 'æŸ¥çœ‹é¡¹ç›®'
  },
];
---

<Layout title="Home" description="A high-performance tech blog and portfolio platform" type="website">
  <style>
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes float {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-20px);
      }
    }

    @keyframes gradient {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    @keyframes pulse-glow {
      0%, 100% {
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
      }
      50% {
        box-shadow: 0 0 40px rgba(59, 130, 246, 0.8);
      }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(-100%);
      }
    }

    .carousel-container {
      position: relative;
      overflow: hidden;
    }

    .carousel-slide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      transition: opacity 0.8s ease-in-out;
      pointer-events: none;
    }

    .carousel-slide.active {
      opacity: 1;
      pointer-events: auto;
      position: relative;
    }

    .carousel-dot {
      transition: all 0.3s ease;
    }

    .carousel-dot.active {
      width: 32px;
      border-radius: 9999px;
    }

    .carousel-nav-btn {
      transition: all 0.3s ease;
    }

    .carousel-nav-btn:hover {
      transform: scale(1.1);
    }

    .card-hover {
      transition: all 0.3s ease;
    }

    .card-hover:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .glow-button {
      animation: pulse-glow 2s ease-in-out infinite;
    }

    .tag-badge {
      transition: all 0.2s ease;
    }

    .tag-badge:hover {
      transform: scale(1.1);
    }

    .section-title {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
  </style>

  <div class="carousel-container min-h-screen relative">
    {carouselItems.map((item, index) => (
      <div 
        class={`carousel-slide ${index === 0 ? 'active' : ''}`}
        data-index={index}
      >
        <div class={`min-h-screen flex items-center justify-center relative bg-gradient-to-br ${item.bgGradient} bg-size-400 bg-animate-gradient`}>
          <div class="absolute inset-0 bg-black/20"></div>
          <div class="absolute top-[-50%] left-[-50%] w-[200%] h-[200%] bg-gradient-radial from-white/10 to-transparent animate-float"></div>
          
          <div class="text-center px-4 py-20 relative z-10 max-w-5xl mx-auto">
            {item.type === 'hero' ? (
              <>
                <h1 class="text-6xl md:text-8xl font-bold mb-6 text-white tracking-tight animate-fadeInUp">
                  {item.title}
                  <span class={`block bg-gradient-to-r ${item.gradient} bg-clip-text text-transparent`}>
                    {item.subtitle}
                  </span>
                </h1>
                <p class="text-xl md:text-2xl text-white/90 mb-8 max-w-2xl mx-auto animate-fadeInUp" style="animation-delay: 0.2s;">
                  {item.description}
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center animate-fadeInUp" style="animation-delay: 0.4s;">
                  <a href={item.link} class="glow-button bg-white text-purple-600 px-8 py-4 rounded-full text-lg font-semibold hover:shadow-lg transition-all hover:scale-105">
                    {item.linkText}
                  </a>
                  <a href={item.secondaryLink} class="bg-transparent border-2 border-white text-white px-8 py-4 rounded-full text-lg font-semibold hover:bg-white hover:text-purple-600 transition-all">
                    {item.secondaryLinkText}
                  </a>
                </div>
              </>
            ) : (
              <>
                <div class="mb-4 animate-fadeInUp">
                  <span class={`inline-block px-4 py-2 rounded-full text-sm font-semibold bg-white/20 text-white backdrop-blur-sm`}>
                    {item.type === 'post' ? 'ğŸ“ ç²¾é€‰æ–‡ç« ' : 'ğŸš€ ç‰¹è‰²é¡¹ç›®'}
                  </span>
                </div>
                <h1 class="text-5xl md:text-7xl font-bold mb-6 text-white tracking-tight animate-fadeInUp" style="animation-delay: 0.1s;">
                  {item.title}
                </h1>
                <p class="text-xl md:text-2xl text-white/90 mb-6 max-w-3xl mx-auto animate-fadeInUp" style="animation-delay: 0.2s;">
                  {item.description}
                </p>
                <div class="flex flex-wrap gap-2 justify-center mb-8 animate-fadeInUp" style="animation-delay: 0.3s;">
                  {item.tags.map((tag) => (
                    <span class="tag-badge bg-white/20 text-white text-sm px-4 py-2 rounded-full backdrop-blur-sm">
                      {tag}
                    </span>
                  ))}
                </div>
                <div class="flex items-center justify-center gap-4 text-white/80 mb-8 animate-fadeInUp" style="animation-delay: 0.4s;">
                  <time>{item.pubDate.toLocaleDateString('zh-CN')}</time>
                </div>
                <div class="animate-fadeInUp" style="animation-delay: 0.5s;">
                  <a href={item.link} class="glow-button bg-white text-purple-600 px-8 py-4 rounded-full text-lg font-semibold hover:shadow-lg transition-all hover:scale-105">
                    {item.linkText} â†’
                  </a>
                </div>
              </>
            )}
          </div>
        </div>
      </div>
    ))}

    <button 
      class="carousel-nav-btn absolute left-4 top-1/2 -translate-y-1/2 z-20 bg-white/20 backdrop-blur-sm text-white p-4 rounded-full hover:bg-white/30"
      id="prevBtn"
      aria-label="Previous slide"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
    </button>

    <button 
      class="carousel-nav-btn absolute right-4 top-1/2 -translate-y-1/2 z-20 bg-white/20 backdrop-blur-sm text-white p-4 rounded-full hover:bg-white/30"
      id="nextBtn"
      aria-label="Next slide"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
    </button>

    <div class="absolute bottom-8 left-1/2 -translate-x-1/2 z-20 flex gap-3">
      {carouselItems.map((_, index) => (
        <button 
          class={`carousel-dot w-3 h-3 rounded-full bg-white/50 hover:bg-white/80 ${index === 0 ? 'active bg-white' : ''}`}
          data-index={index}
          aria-label={`Go to slide ${index + 1}`}
        ></button>
      ))}
    </div>
  </div>

  <script>
    (function() {
      const slides = document.querySelectorAll('.carousel-slide');
      const dots = document.querySelectorAll('.carousel-dot');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      let currentIndex = 0;
      let autoPlayInterval;

      function showSlide(index) {
        // Preload next slide's images if available
        if (slides[index]) {
          const images = slides[index].querySelectorAll('img');
          images.forEach(img => {
            if (img.loading === 'lazy') {
              img.loading = 'eager';
            }
          });
        }
        
        slides.forEach((slide, i) => {
          if (i === index) {
            slide.classList.add('active');
            dots[i].classList.add('active', 'bg-white');
            dots[i].classList.remove('bg-white/50');
          } else {
            slide.classList.remove('active');
            dots[i].classList.remove('active', 'bg-white');
            dots[i].classList.add('bg-white/50');
          }
        });
        
        currentIndex = index;
      }

      function nextSlide() {
        const nextIndex = (currentIndex + 1) % slides.length;
        showSlide(nextIndex);
      }

      function prevSlide() {
        const prevIndex = (currentIndex - 1 + slides.length) % slides.length;
        showSlide(prevIndex);
      }

      function startAutoPlay() {
        autoPlayInterval = setInterval(nextSlide, 5000);
      }

      function stopAutoPlay() {
        clearInterval(autoPlayInterval);
      }

      // Add keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') {
          prevSlide();
          stopAutoPlay();
          startAutoPlay();
        } else if (e.key === 'ArrowRight') {
          nextSlide();
          stopAutoPlay();
          startAutoPlay();
        }
      });

      // Add touch/swipe support for mobile
      let touchStartX = 0;
      let touchEndX = 0;
      
      document.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
      });

      document.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      });

      function handleSwipe() {
        const minSwipeDistance = 50;
        const swipeDistance = touchStartX - touchEndX;
        
        if (Math.abs(swipeDistance) > minSwipeDistance) {
          if (swipeDistance > 0) {
            nextSlide(); // Swipe left - go to next
          } else {
            prevSlide(); // Swipe right - go to prev
          }
          stopAutoPlay();
          startAutoPlay();
        }
      }

      nextBtn.addEventListener('click', () => {
        nextSlide();
        stopAutoPlay();
        startAutoPlay();
      });

      prevBtn.addEventListener('click', () => {
        prevSlide();
        stopAutoPlay();
        startAutoPlay();
      });

      dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
          showSlide(index);
          stopAutoPlay();
          startAutoPlay();
        });
      });

      // Pause autoplay on hover
      const carouselContainer = document.querySelector('.carousel-container');
      carouselContainer.addEventListener('mouseenter', stopAutoPlay);
      carouselContainer.addEventListener('mouseleave', startAutoPlay);

      startAutoPlay();
    })();
  </script>


</Layout>
